{% set form_id = 'form_' ~ uniq() %}

<div id="{{ form_id }}_success" class="alert alert-success" style="display:none">
  {{ success_message|nl2br }}
</div>

{{ form_start(form, {
  attr: {
    id: form_id
  }
}) }}
  {{ form_row(form.recipient) }}
  {{ form_row(form.name) }}
  {{ form_row(form.email) }}
  {{ form_row(form.phone) }}
  {{ form_row(form.message) }}
  {{ form_row(form.captcha) }}

  <div id="{{ form_id }}_error" class="alert alert-danger" style="display:none"></div>

{{ form_end(form) }}

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('{{ form_id }}');

  const success = document.getElementById('{{ form_id }}_success');
  const error = document.getElementById('{{ form_id }}_error');

  const submitButton = form.querySelector('[type=submit]');

  let submitting = false;

  function submitForm() {
    if (submitting) {
      return;
    }

    submitting = true;
    success.style.display = 'none';
    error.style.display = 'none';
    submitButton.textContent = 'Submitting...';
    submitButton.disabled = true;

    const formData = new FormData(form);

    fetch('{{ path('contact_form_post') }}', {
      method: 'post',
      body: formData,
    })
      .then(r => r.json())
      .then((r) => {
        if (r.success) {
          success.style.display = '';
        } else {
          error.innerHTML = r.errors.join('<br>');
          error.style.display = '';
        }
      })
      .catch((e) => {
        error.textContent = 'Something unexpected happened.';
        error.style.display = '';
      })
      .finally(() => {
        submitting = false;
        submitButton.textContent = 'Submit';
        submitButton.disabled = false;
      });
  }

  form.addEventListener('submit', (e) => {
    e.preventDefault();

    submitForm();

    return false;
  });
});
</script>
